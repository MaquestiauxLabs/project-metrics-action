name: Move Issue to In Progress

on:
  create:
  push:
    branches:
      - "*/issue*"

jobs:
  move-to-in-progress:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      repository-projects: write

    steps:
      - name: Extract issue number from branch name
        id: extract
        run: |
          BRANCH_NAME=${{ github.ref_name }}
          echo "Branch: $BRANCH_NAME"

          # Extract issue number from pattern like "username/issue123" or "user/issue#123"
          if [[ $BRANCH_NAME =~ ^[^/]+/issue#?([0-9]+)$ ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Issue number extracted: $ISSUE_NUMBER"
          else
            echo "Branch name does not match expected pattern"
            exit 0
          fi

      - name: Move issue to In Progress
        if: steps.extract.outputs.issue_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GTHB_TOKEN_PAT }}
          script: |
            const issueNumber = ${{ steps.extract.outputs.issue_number }};
            const projectId = '${{ vars.PROJECT_V2_ID}}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`Moving issue #${issueNumber} to "In Progress"`);

            // Get the issue to ensure it exists
            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber,
            });

            console.log(`Issue found: ${issue.data.title}`);

            // Query to find the project item for this issue
            const query = `
              query($owner: String!, $repo: String!, $issue: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issue) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                ... on ProjectV2SingleSelectField {
                                  id
                                  name
                                }
                              }
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const response = await github.graphql(query, {
              owner,
              repo,
              issue: issueNumber
            });

            if (response.errors) {
              console.error('GraphQL Errors:', response.errors);
              throw new Error(`GraphQL error: ${JSON.stringify(response.errors)}`);
            }

            console.log('Query response:', JSON.stringify(response, null, 2));

            const projectItems = response.repository?.issue?.projectItems?.nodes || [];
            const projectItem = projectItems.find(item => item.project.id === projectId);

            if (!projectItem) {
              console.log(`Issue #${issueNumber} is not in the project ${projectId}`);
              return;
            }

            console.log(`Found project item: ${projectItem.id}`);

            // Find the Status field
            const statusField = projectItem.fieldValues.nodes.find(
              field => field.field?.name === 'Status'
            );

            if (!statusField || !statusField.field) {
              console.log('Status field not found in project item');
              return;
            }

            const statusFieldId = statusField.field.id;
            console.log(`Status field ID: ${statusFieldId}`);

            // Get the field options to find the "In Progress" option ID
            const fieldQuery = `
              query($fieldId: ID!) {
                node(id: $fieldId) {
                  ... on ProjectV2SingleSelectField {
                    options {
                      id
                      name
                    }
                  }
                }
              }
            `;

            const fieldResponse = await github.graphql(fieldQuery, {
              fieldId: statusFieldId
            });
            const inProgressOption = fieldResponse.node.options.find(
              option => option.name === 'In Progress'
            );

            if (!inProgressOption) {
              console.log('In Progress option not found');
              return;
            }

            console.log(`In Progress option ID: ${inProgressOption.id}`);

            // Update the project item status
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            const updateResponse = await github.graphql(updateMutation, {
              projectId,
              itemId: projectItem.id,
              fieldId: statusFieldId,
              optionId: inProgressOption.id
            });
            console.log(`âœ… Issue #${issueNumber} moved to "In Progress"`);
